<?php
session_start();
include_once "../includes/db-conn.php";

if (isset($_POST['create-new-blog'])) {
    $email = $_SESSION['current_user_email'];
    $title = $_POST['title'] ?? ''; // Avoid undefined variable
    $desc = $_POST['desc'];
    $eventDate = $_POST['event-date'];
    $visibility = getVisibility();

    // Validate the title of the blog
    if (!preg_match('/^[a-zA-Z0-9].*/', $title)) {
        echo "<script>
            alert('Title must start with a letter or number only.');
            window.history.back();
        </script>";
        exit;
    }

    // Insert blog details into the database
    $sql = 'INSERT INTO blogs (creator_email, title, description, event_date, privacy_filter) VALUE (?,?,?,?,?)';

    if ($stmt = $conn->prepare($sql)) {
        $stmt->bind_param('sssss', $email, $title, $desc, $eventDate, $visibility);

        if ($stmt->execute()) {
            $flag = TRUE;
            // Get autogenerated blog ID and create directory
            $blog_id = $conn->insert_id;
            $blog_dir = '../images/' . $blog_id;
            mkdir($blog_dir);
            $conn->close();

            // Handle multiple file uploads
            if (isset($_FILES['new-blog-images'])) {
                $files = $_FILES['new-blog-images'];
                $allowedSize = 500000; // Max file size

                foreach ($files['tmp_name'] as $key => $tmp_name) {
                    if ($files['error'][$key] == 0) {
                        // Validate file size
                        if ($files['size'][$key] > $allowedSize) {
                            echo "File too large: " . $files['name'][$key];
                            continue; // Skip to next file
                        }

                        // Move uploaded file to the blog directory
                        $finalPath = $blog_dir . '/' . $files['name'][$key];
                        move_uploaded_file($tmp_name, $finalPath);
                    } else {
                        echo "Error uploading file: " . $files['name'][$key];
                    }
                }
            }

            // Redirect to index after processing
            header('Location: ../index.php');
            exit;
        } else {
            echo 'Error: ' . $stmt->error;
        }
        $stmt->close();
    }
}

function getVisibility() {
    return isset($_POST['visibility']) ? 'public' : 'private';
}
?>
