<?php
session_start();
include_once "../includes/db-conn.php";

if (isset($_POST['create-new-blog'])) {
    $email = $_SESSION['current_user_email'];
    $title = $_POST['title'];
    $desc = $_POST['desc'];
    $eventDate = $_POST['event-date'];
    $visibility = getVisibility();

    $sql = 'INSERT INTO blogs (creator_email, title, description, event_date, privacy_filter) VALUE (?,?,?,?,?)';

    if ($stmt = $conn->prepare($sql)) {
        $stmt->bind_param('sssss', $email, $title, $desc, $eventDate, $visibility);
        
        if ($stmt->execute()) {
            $flag = TRUE;
            // Get autogenerated blog ID and make directory.
            $blog_id = $conn->insert_id;
            $blog_dir = '../images/'.$blog_id;
            mkdir($blog_dir);
            $conn->close();
            
            // Check file size
            if ($_FILES["fileToUpload"]["size"] > 500000) {
            echo "file is too large.";
            $uploadOk = 0;
            $flag = FALSE; // file will NOT be uploaded next
            
            }

            if ($flag == TRUE){
            // Add image to database (WIP)
            $tempFileName = $_FILES['new-blog-images']['tmp_name'];
            $finalPath = $blog_dir . '/' . $_FILES['new-blog-images']['name'];
            move_uploaded_file($tempFileName, $finalPath);
            header('Location: ../index.php');
            exit;
            
            }
            else{
                header('Location: ../index.php');
                exit;
            }
        } else {
            echo 'Error: '.$stmt->error;
        }
        $stmt->close();
    }
    
}

function getVisibility() {
    if (isset($_POST['visibility'])) {
        return 'public';
    } else {
        return 'private';
    }
}
?>